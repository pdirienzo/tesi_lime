<link href="css/drop.css" rel="stylesheet" />
<LINK href="css/bootstrap.css" rel="stylesheet" type="text/css" />


<!-- Scripting -->
<script type="text/javascript">

function getItems(exampleNr)
{
	var columns = [];

	$(exampleNr + ' ul.sortable-list').each(function(){
		columns.push($(this).sortable('toArray').join(','));				
	});

	return columns.join('|');
} 	



$(document).ready(function(){
	
	$("#infopanel").hide(); //nascondiamo il pannello info
	$.getJSON("HypervisorInfo", function(hypervisorList){
		
		html="<p><button>Migrate</button></p>";
		var i;
		html+="<div class='row'>";
		for(i=0; i<hypervisorList.length; i++) {
			
			html += "<div class='left span3 '>";
			
			hypervisor = hypervisorList[i];
			if (hypervisor.status == "online"){
				html += "<label >"+hypervisor.ip+" ("+hipervisor.status+")</label>";
				html += "<ul class='sortable-list'>";
				for(j in hypervisor.machines){
					vmachine = hypervisor.machines[j];
					if (vmachine.status=="running"){
						html += "<li class='sortable-item' id="+vmachine.name+">"+vmachine.name+" ("+
							vmachine.status+")</li>";
					}
					else if (vmachine.status=="stopped"){
						html += "<li class='unsortable' id="+vmachine.name+">"+vmachine.name+" ("+
						vmachine.status+")</li>";
					}
				}
			
				html += "</ul></div>";
			}else {
				html += "<h3 >"+hypervisor.ip+" ("+hypervisor.status+")</h3>";
				html += "<ul class='unsortable-list'>";
				html +="</ul></div>";
			}
		}
		html+="</div>";
	
		$("#infopanel").html(html);
		 
		 
		$("#infopanel ul.sortable-list").sortable({
		    items: "li:not(.unsortable)"
		    //connectWith: "#infopanel ul.sortable-list"
		});
		$("#infopanel ul.sortable-list").disableSelection();
		$('#infopanel ul.sortable-list').sortable({
			connectWith: '#infopanel ul.sortable-list'
		});
		$('#btn-get').click(function(){
			alert(getItems('#infopanel'));
		});
		
		$("#loadingMask").fadeOut("slow",function(){
			$("#infopanel").fadeIn("slow");
		});
		
		//$("#loadingMask").hide();
		//$("#infopanel").show();
	});
	
	/*function setMigration(hvList) {
		html="<p>Are you sure that you wanna migrate? <p>";
		
		var arrayOfIDs=[];
		$('#infopanel label.ipaddress').each(function(){
			arrayOfIDs.push($(this).text());
		});
		alert(hvList[0].ip);
		html+="<div id='currentmachine'>"+arrayOfIDs+"</div>"
		$("#migration-box").html(html);
		$("#migration-box").dialog("open");
	}*/


	function migrate(){
		vmachine = document.getElementById("currentmachine").innerHTML;
		ipsrc = document.getElementById("currentip").innerHTML;
		ipdst = document.getElementById("dstbox").value;
		
		$.getJSON("Migration?vmname="+vmachine+"&srcip="+ipsrc+"&dstip="+ipdst, function(response){
			$("#migration-box").dialog("close");
			
			$("#progress-bar").progressbar("value", false);
			$("#progress-box").dialog("open");
			refreshProgress();
		});
	}

	function refreshProgress(){
		$.getJSON("MigrationStatus", function(response){
			if(response.state=="2") {
				$("#progress-bar").progressbar("value", 100);
				$.getJSON("GetElapsedTime", function(response){
					text = "Tempo trascorso " + response.elapsed/1000 + " s";
					$("#memory-progress").html(text);
					showMachines();
				});
			} else if (response.state == "1") {
				val  = response.processed*100/response.total;
				$("#progress-bar").progressbar("value", Math.ceil(val));
				
				text = "Trasferimento " + Math.ceil(response.processed/1024/1024) + "/" + 
					Math.ceil(response.total/1024/1024) + " MB "; 
				$("#memory-progress").html(text);
				
				setTimeout(refreshProgress, 500);
			} else if (response.state == "0") {
				alert("state is 0");
			} else {
				
				alert("Impossibile effettuare la migrazione.");
				$.getJSON("GetElapsedTime", function(response){
					$("#progress-box").dialog("close");
				});
			}
		});
	}
	
	
	
});
</script>
<!-- End scripting section -->


<style type="text/css">
.content {
	margin: auto;
	text-align: center;
	padding: 10px;
	border: 2px solid #808080;
	height: auto;
}
;
</style>
<div class="content">
	<!-- Pre Loading... -->
	<div id="loadingMask" style="background: none repeat scroll 0% 0% rgb(255, 255, 255); 
		margin-top: 0px; width: inherit; height: inherit;">
		<img src="images/loading.gif" width="300px">
	</div>
	
	<!-- BEGIN: HTML for Hypervisor -->

	<div id="infopanel"></div>
	<div class="clearer">&nbsp;</div>

	<!-- END: HTML for Hypervisor 
	
	<div id="migration-box"></div>
			<div id="progress-box">
				<h3 align="center">Migrazione in corso</h3>
				<div id="progress-bar"><div id="progress-text"></div></div>
				<div id="memory-progress"></div>
	</div>
	-->
</div>
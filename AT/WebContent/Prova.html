<link href="css/drop.css" rel="stylesheet" />

<script src="js/jquery.dialogextend.js"></script>
<script src="js/jquery.dialogextend.min.js"></script>
<style type="text/css">
.content {
    margin: auto;
    text-align: center;
    padding: 10px;
    border: 2px solid #808080;
    height: auto;
}
;
</style>
<div class="content">
    <!-- Pre Loading... -->
    <div id="loadingMask"
        style="background: none repeat scroll 0% 0% rgb(255, 255, 255); margin-top: 0px; width: inherit; height: inherit;">
        <img src="images/loading.gif" width="300px">
    </div>

    <!-- BEGIN: HTML for Hypervisor -->

    <div id="infopanel"></div>
    <div class="clearer">&nbsp;</div>

    <!-- END: HTML for Hypervisor -->

    <div id="migration-box"></div>
    <!-- <div id="progress-box">
                <h3 align="center">Migrazione in corso</h3>
                <div id="progress-bar"><div id="progress-text"></div></div>
                <div id="memory-progress"></div>
            </div> -->
    <!-- <div class="migration">
        <h3 align="center">Migrazione in corso</h3>
        <div class="machine"></div>
        <div class="progress-bar2"><div id="progress-text"></div></div>
        <div class="memory-progress2"></div>
    </div> -->
</div>

<script type="text/javascript">
    /* $("#migration-box").dialog({
     title    : "Migrazione",
     buttons  : [{text: "Migra", click: function() {migrate();}},
     {text: "Annulla", click: function() {$(this).dialog("close");}}],
     autoOpen : false,
     hide     : "explode",
     modal    : true
     }); */

    $("div .migration").dialog({
        "title" : "Migrazione in corso",
        "autoOpen" : false,
        "hide" : "explode",
        "buttons" : {
            "Close" : function() {
                $("#wrapper .ui-widget-overlay").remove();
                $(this).dialog("close");
            }
        }
    }).dialogExtend({
        "closable" : false, // enable/disable close button
        "minimizable" : true, // enable/disable minimize button
        "minimizeLocation" : "right", // sets alignment of minimized dialogues
        "icons" : { // jQuery UI icon class
            "close" : "ui-icon-circle-close",
            "maximize" : "ui-icon-circle-plus",
            "minimize" : "ui-icon-circle-minus",
            "collapse" : "ui-icon-triangle-1-s",
            "restore" : "ui-icon-bullet"
        }
    });

    $("#progress-box").dialog({
        title : "Migrazione in corso",
        buttons : [ {
            text : "Chiudi",
            click : function() {
                $(this).dialog("close");
            }
        } ],
        autoOpen : false,
        hide : "explode",
        modal : true
    });

    $("#progress-bar").progressbar({
        value : false,
        change : function() {
            bar = $("#progress-bar");
            $("#progress-text").text(bar.progressbar("value") + " % ");
        },
        complete : function() {
            $("#progress-text").text("Migrazione completata");
        }
    });

    /* $(".progress-bar2").progressbar({
     value : false,
     change: function() {
     bar = $(".progress-bar2");
     $("#progress-text").text(bar.progressbar("value")+" % ");
     },
     complete: function() {
     $("#progress-text").text("Migrazione completata");
     }
     }); */

    function getDummy() {
        var myJsonObject = [ {
            "status" : "online",
            "ip" : "pasquale@143.255.229.170",
            "machines" : [ {
                "status" : "running",
                "name" : "link2"
            }, {
                "status" : "running",
                "name" : "linked2"
            } ]
        }, {
            "status" : "online",
            "ip" : "enrico@143.255.229.172",
            "machines" : [ {
                "status" : "running",
                "name" : "linkedin2"
            }, {
                "status" : "running",
                "name" : "linux2"
            } ]
        } ];
        return myJsonObject;
    }

    function getList() {
        $("#infopanel").hide(); //nascondiamo  btn-primaryil pannello info
        //$.getJSON("HypervisorInfo", function(hypervisorList){
        hypervisorList = getDummy();
        hvList = hypervisorList;
        html = "<p><button type='button' class='btn' onclick=\"setMigration(hvList);\">Migrate</button></p>";
        var i;
        html += "<div class='row'>";
        for (i = 0; i < hypervisorList.length; i++) {

            html += "<div class='left span3 '>";

            hypervisor = hypervisorList[i];
            if (hypervisor.status == "online") {

                html += "<label id='"+hypervisor.ip+"' class='iphyp-online' >"
                        + hypervisor.ip + " (" + hypervisor.status
                        + ")</label>";

                html += "<ul class='sortable-list'>";
                for (j in hypervisor.machines) {

                    vmachine = hypervisor.machines[j];
                    if (vmachine.status == "running") {
                        html += "<li class='sortable-item' id="+vmachine.name+">"
                                + vmachine.name
                                + " ("
                                + vmachine.status
                                + ")</li>";
                    } else if (vmachine.status == "stopped") {
                        html += "<li class='unsortable' id="+vmachine.name+">"
                                + vmachine.name + " (" + vmachine.status
                                + ")</li>";
                    }
                }

                html += "</ul></div>";
            } else {
                html += "<label id='"+hypervisor.ip+"' class='iphyp-offline'>"
                        + hypervisor.ip + " (" + hypervisor.status
                        + ")</label>";
                html += "<ul class='unsortable-list'>";
                html += "</ul></div>";
            }
        }
        html += "</div>";

        $("#infopanel").html(html);

        $("#infopanel ul.sortable-list").sortable({
            items : "li:not(.unsortable)"
        //connectWith: "#infopanel ul.sortable-list"
        });
        $("#infopanel ul.sortable-list").disableSelection();
        $('#infopanel ul.sortable-list').sortable({
            connectWith : '#infopanel ul.sortable-list'
        });

        $("#loadingMask").fadeOut("slow", function() {
            $("#infopanel").fadeIn("slow");
        });

        //$("#loadingMask").hide();
        //$("#infopanel").show();
        //});
    }

    function getItems() {

        var hyp = [];
        var name;
        $('div.span3 label.iphyp-online').each(function() {
            name = $(this).attr("id");
            hyp.push({
                Name : name,
                Vm : []
            });
        });
        var k = 0;
        $('div.span3 ul.sortable-list').each(function() {
            hyp[k].Vm = $(this).sortable('toArray');
            k++;
        });

        return hyp;
    }

    function setMigration(hvList) {
        html = "<p>Are you sure that you wanna migrate? <p>";
        var hyp = [];
        k = 0;
        for (i = 0; i < hvList.length; i++) {
            hypervisor = hvList[i];

            if (hypervisor.status == "online") {
                var name = hypervisor.ip;
                var machine = [];
                hyp.push({
                    Name : name,
                    Vm : []
                });
                for (j in hypervisor.machines) {
                    vmachine = hypervisor.machines[j];
                    if (vmachine.status == "running") {
                        machine.push(vmachine.name);
                    }
                }
                hyp[k].Vm = machine;
                k++;
            }
        }
        var name = [];
        var k = 0;
        //var hyp_after=getItems();
        for (i = 0; i < hyp.length; i++) {
            for (j = 0; j < hyp[i].Vm.length; j++) {
                var ip = $(
                        "div.span3 ul.sortable-list li:contains('"
                                + hyp[i].Vm[j] + "')").parent().parent().find(
                        "label").attr("id");
                if (ip != hyp[i].Name) {
                    html += "<p>From: " + hyp[i].Name + " to:" + ip
                            + " the following machine: " + hyp[i].Vm[j]
                            + "</p>";
                    name[k] = hyp[i].Name + "|" + ip + "|" + hyp[i].Vm[j];
                    k++;
                }
            }
        }

        $("#migration-box").dialog({
            title : "Migrazione",
            buttons : [ {
                text : "Migra",
                click : function() {
                    migrate(name);
                }
            }, {
                text : "Annulla",
                click : function() {
                    $(this).dialog("close");
                }
            } ],
            autoOpen : false,
            hide : "explode",
            modal : true
        });

        $("#migration-box").html(html);

        $("#migration-box").dialog("open");

    }

    function migrate(name){
        $("#migration-box").dialog("close");
        $("#wrapper").append("<div class='ui-widget-overlay ui-front'></div>");
        
           for (i = 0; i < name.length; i++) {
            var res = name[i].split("|");
            $.getJSON("Migration?vmname="+res[2]+"&srcip="+res[0]+"&dstip="+res[1], function(response){
            var dialogo = "<div id='"+i+"_Migra' class='dialogo'>" + "<p>Da: <strong>"
                    + res[0] + "</strong><br /> a: <strong>" + res[1] + "</strong><br /> "+
                    "di: <strong>" + res[2] + "</strong></p>"
                    + "<div class='progress-bar2'><div class='progress-text'>"
                    + "</div></div><div class='memory-progress2'></div></div>";
            $(".clearer").append(dialogo);
            var openDialog = "#" + i + "_Migra";
            $(".progress-bar2").progressbar({
                value : false,
                change : function() {
                    bar = $(".progress-bar2");
                    $(".progress-text").text(bar.progressbar("value") + " % ");
                },
                complete : function() {
                    $(".progress-text").text("Migrazione completata");
                }
            });
            $(openDialog).dialog({
                "title" : "Migrazione in corso",
                "autoOpen" : false,
                "buttons" : {
                    "Close" : function() {
                        $("#wrapper .ui-widget-overlay").remove();
                        $(this).dialog("close");
                    }
                }
            }).dialogExtend({
                "closable" : false, // enable/disable close button
                "minimizable" : true, // enable/disable minimize button
                "minimizeLocation" : "right", // sets alignment of minimized dialogues
                "icons" : { // jQuery UI icon class
                    "close" : "ui-icon-circle-close",
                    "maximize" : "ui-icon-circle-plus",
                    "minimize" : "ui-icon-circle-minus",
                    "collapse" : "ui-icon-triangle-1-s",
                    "restore" : "ui-icon-bullet"
                }
            });
            $(openDialog + " > .progress-bar2").progressbar("value", false);
            $(openDialog).dialog("open");
            var srcip = res[0].split("@")[1];
            var dstip = res[1].split("@")[1];
            var idsd = srcip.split(".")[3] + "-" + dstip.split(".")[3]
            var id = "lm-" + res[2] + "-" + idsd;
            //alert(id);
            refreshProgress(id);
            }); //endJSON
            }
    }
    //Prova

    function refreshProgress(id) {
        $.getJSON("MigrationStatus?lmid="+id, function(response) {
            if (response.state == "2") {
                $(".progress-bar2").progressbar("value", 100);
                $.getJSON("GetElapsedTime", function(response) {
                    text = "Tempo trascorso " + response.elapsed / 1000 + " s";
                    $("memory-progress2").html(text);
                    showMachines();
                });
            } else if (response.state == "1") {
                val = response.processed * 100 / response.total;
                $("progress-bar2").progressbar("value", Math.ceil(val));

                text = "Trasferimento "
                        + Math.ceil(response.processed / 1024 / 1024) + "/"
                        + Math.ceil(response.total / 1024 / 1024) + " MB ";
                $("memory-progress2").html(text);

                setTimeout(refreshProgress, 500);
            } else if (response.state == "0") {
                alert("state is 0");
            } else {

                alert("Impossibile effettuare la migrazione.");
                $.getJSON("GetElapsedTime", function(response) {
                    $("migration").dialog("close");
                });
            }
        });
    }

    getList();
</script>
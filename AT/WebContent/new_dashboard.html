<link href="css/dashboard_style.css" rel="stylesheet" />

<style>
.danger {
	color: black !important;
	background: -webkit-linear-gradient(#d2322d, #d23277) !important; /* For Safari 5.1 to 6.0 */
	background: -o-linear-gradient(#d2322d, #d23277) !important; /* For Opera 11.1 to 12.0 */
	background: -moz-linear-gradient(#d2322d, #d23277) !important; /* For Firefox 3.6 to 15 */
	background: linear-gradient(#d2322d, #d23277) !important; /* Standard syntax (must be last) */
}

.vm_danger {
	color: black !important;
	background: rgba(255, 0, 0, 0.58) !important;
}

.warning {
	color: black !important;
	background: -webkit-linear-gradient(#f89406, #f89450) !important; /* For Safari 5.1 to 6.0 */
	background: -o-linear-gradient(#f89406, #f89450) !important; /* For Opera 11.1 to 12.0 */
	background: -moz-linear-gradient(#f89406, #f89450) !important; /* For Firefox 3.6 to 15 */
	background: linear-gradient(#f89406, #f89450) !important; /* Standard syntax (must be last) */
}

.vm_warning {
	color: black !important;
	background: rgba(248, 148, 6, 0.58) !important;
}

.normal {
	color: black !important;
	background: -webkit-linear-gradient(#47a447, #47a491) !important; /* For Safari 5.1 to 6.0 */
	background: -o-linear-gradient(#47a447, #47a491) !important; /* For Opera 11.1 to 12.0 */
	background: -moz-linear-gradient(#47a447, #47a491) !important; /* For Firefox 3.6 to 15 */
	background: linear-gradient(#47a447, #47a491) !important; /* Standard syntax (must be last) */
}

.vm_normal {
	color: black !important;
	background: rgba(28, 229, 28, 0.58) !important;
}

.vm_box {
	background: -webkit-linear-gradient(gray, black); /* For Safari 5.1 to 6.0 */
	background: -o-linear-gradient(gray, black); /* For Opera 11.1 to 12.0 */
	background: -moz-linear-gradient(gray, black); /* For Firefox 3.6 to 15 */
	background: linear-gradient(gray, black); /* Standard syntax */
}

</style>

<script>

/* function getDummy(){
    var myJSONObject = [{"ip": "sprom@dell-Sprom",
               "cpuinfo" : 91,
               "machines" : [{
                   "status" : "running",
                   "name" : "linx2",
                   "cpustats" : 91
               },
               {
                   "status" : "running",
                   "name" : "server2",
                   "cpustats" : 75
               }]
    },
    {"ip": "pasquale@pasq-VAIO",
        "cpuinfo" : 80,
        "machines" : [{
            "status" : "running",
            "name" : "linx2",
            "cpustats" : 60
        },
        {
            "status" : "running",
            "name" : "server2",
            "cpustats" : 30
        }]
    }];
    return myJSONObject;
}
 */
 
 var controlOp = new Object(); //this is a shared object containing details about current control operation
 
 $(document).ready(function(){
	 getHypervisor(true);
	 $.getJSON("DomainControl?action=list_flavours",function(result){
		 console.log(result);
	 });
 }); 
 
 function controlHypervisor(){
	 $.getJSON("DomainControl?action="+controlOp.action+"&hypervisorId="+controlOp.hypervisor+"&guestName="+controlOp.guest,function(result){
     		if(result.result == "error"){
     			showDialog("Errore","Request failed: "+result.details);
     		}
     });
	 
	 $("#vm_menu").dialog("close");
	 showDialog("Info","Sending a "+controlOp.action+" request for "+controlOp.guest);
 }

 function getHypervisor(firstRun){
	 $.getJSON("HypervisorInfo", function(hvList){
	     var hypervisorList = hvList;
	     
	     if(firstRun == true){ //first time we create the labels and the accordion
	    	 var html="";
	    	 for(var i=0; i<hypervisorList.length; i++) {
		         var hypervisor = hypervisorList[i];
	    	 	 html += "<label id=\""+hypervisor.id+"\"></label><div class=\"vm_box\"><div id=\""+hypervisor.id+"_box\">";
	   
	 	       	 for(j in hypervisor.machines){
	 	       		 vmachine = hypervisor.machines[j];
	 	       		 html += "<button name='"+vmachine.name+"' class=\"vmbutton\" ></button><div class=\"clearer\" style=\"height:5px;\" />";
	 	       	 }
	 	       	 
	 	       	 html += "<button class=\"crbutton\" name=\"crB\">Crea Nuova VM</button><br />";
	 	       	 
	    	 	 html += "</div></div>";
 
	    	 }
	    	 
	    	 $("#hypervisormenu").append(html);
	    	 
		  
	    	 $("#hypervisormenu").accordion({
		         heightStyle: "content",
		         collapsible: true,
		         active: false 
		     });
	    	 
	    	 $("#vm_menu").dialog({
	             title : "Control",
	             autoOpen : false,
	             resizable: false,
	             modal:true
	    	 });
	    	 
	    	 $("#new_vm_run input").switchButton();
	    	 
	    	 $("#vm_creation").dialog({
	    		title : "Il potere della creazione",
	    		autoOpen : false,
	    		resizable : false,
	    		modal : true,
	    		buttons : [ {
	    			text : "Crea",
	    			click : function() {
	    				vmName = $('#new_vm_name input').val();
	    				if(vmName != ""){
	    					controlOp.flavour = $('#new_vm_flavour select :selected').text();
	    					controlOp.guest = "VPM-"+vmName;
	    					controlOp.autostart = $('#new_vm_run input').switchButton("option","checked"); 
	    					
	    					 $.getJSON("DomainControl?action="+controlOp.action+"&hypervisorId="+controlOp.hypervisor+"&guestName="+controlOp.guest
	    							 +"&flavour="+controlOp.flavour+"&autostart="+controlOp.autostart,function(result){
	    				     		if(result.result == "error"){
	    				     			showDialog("Errore","Request failed: "+result.details);
	    				     		}
	    				     		$('#vm_creation_box').show();
	    							$('#vm_creation_loader').hide();
	    					});
	    					 
	    					$('#vm_creation_box').hide();
	    					$('#vm_creation_loader').show();
	    				}else
	    					showDialog("Error","Il nome non puo' essere vuoto!");
	    				
	    			}
	    		}]
	    	 });
	    	 
	    	 $(".crbutton").button().click(function(event){
	     		event.preventDefault();
	     		controlOp.hypervisor = this.parentNode.id.split("_")[0];
	     		controlOp.action = "create";
	     		
	     		$('#new_vm_name input').val("");
	    		$("#vm_creation").dialog("open"); 
	    		$('#vm_creation_box').show();
				$('#vm_creation_loader').hide();
	    		
	    	 });
	    	 
	    	 $( ".vmbutton" ).button().click(function( event ) {
		 	       	event.preventDefault();
		 	        $("#vm_menu").dialog("option","title",this.name+" Control");
		 	        
		 	        controlOp.hypervisor = this.parentNode.id.split("_")[0];
		 	        controlOp.guest = this.name;
	 	       		
		 	       	if(this.getAttribute('status') == "offline"){
		 	       	    controlOp.action = "boot";
		 	       		$("#vm_menu button[name=shutVM]").switchClass("ui-state-enabled","ui-state-disabled");
		 	       		$("#vm_menu button[name=startVM]").switchClass("ui-state-disabled","ui-state-enabled");
		 	       	}else if (this.getAttribute('status') == "online"){
		 	          	controlOp.action = "shutdown";
		 	       		$("#vm_menu button[name=shutVM]").switchClass("ui-state-disabled","ui-state-enabled");
		 	       	    $("#vm_menu button[name=startVM]").switchClass("ui-state-enabled","ui-state-disabled");
		 	       	}
      	
		 	       $("#vm_menu").dialog("open");
		 	       
	    	 }); 
	    	 
	     }
	     
	     //--------------------------- end first run ------------------------------
	     $("#hypervisors-infopanel label").text("Hypervisor disponibili ("+hypervisorList.length+")");
	     //updating informations. This is done anyways
	     for(var i=0; i<hypervisorList.length; i++) {
	    	 var hypervisor = hypervisorList[i];
	    	 var labelId = $("#"+hypervisor.id);
	    	 
	    		 labelId.removeClass("normal warning danger");
	    		 if (hypervisor.status=="online"){
	    			$("#"+hypervisor.id+"_box button[name=crB]").button("option","disabled",false);//switchClass("ui-state-disabled","ui-state-enabled"); 
	    			 
		 	        if(hypervisor.cpuUsage > WARNING_THRESHOLD && hypervisor.cpuUsage < DANGER_THRESHOLD){ //warning zone
		 	        	labelId.addClass("warning");
		 	        }else if (hypervisor.cpuUsage >=DANGER_THRESHOLD){ //danger zone
		 	        	labelId.addClass("danger");
		 	        }else { //normal
		 	        	labelId.addClass("normal");
		 	        }
		 	        
		 	       	for(j in hypervisor.machines){
		 	       		var vmachine = hypervisor.machines[j];
		 	       		var vmButton = $("#"+hypervisor.id+"_box button[name="+vmachine.name+"]");
		 	       		if(vmButton != null){ //maybe some vm has been deleted from the hypervisor
		 	       			
		 	       			var vmButtonSpan = vmButton.find("span");
		 	       		
		 	       	    	$("#"+hypervisor.id+"_box button[name="+vmachine.name+"]").removeClass("vm_normal vm_warning vm_danger");
		 	       	    	if (vmachine.status=="running"){
		 	       	    		vmButton.attr("status","online");
		 	       	    		
		             			if (vmachine.cpuUsage > WARNING_THRESHOLD && vmachine.cpuUsage < DANGER_THRESHOLD){
		             				vmButton.addClass("warning");
		             			}else if (vmachine.cpuUsage >= DANGER_THRESHOLD){
		             				vmButton.addClass("danger"); 
		                 		}else{ 
		                 			vmButton.addClass("vm_normal");
		                 		}
		             		
		             			vmButtonSpan.html("<b>"+vmachine.name+"</b> (<i>"+vmachine.status+" "+vmachine.cpuUsage+"</i>)");
		             
		             		}else{ //if the vm is not online we don't need to add any class
		             			vmButton.attr("status","offline");
		             			vmButtonSpan.html("<b>"+vmachine.name+"</b> (<i>"+vmachine.status+"</i>)");
		             		}
		 	       	    	
		 	       		}else{//if server sent some unknown vm it means that a new vm was added while the user was still in this page
		 	       			location.reload(); //so we refresh the page
		 	       		}
		 	       	}

		 	        labelId.text(hypervisor.ip+" ("+hypervisor.cpuUsage+"%)");
		 	        
	    	 	}else{
	    	 		$("#"+hypervisor.id+"_box button[name=crB]").button("option","disabled",true);//.switchClass("ui-state-enabled","ui-state-disabled");
	    	 		labelId.text(hypervisor.ip+" (offline)");
	    	 	}
	     }
	     
	     $('#hypervisormenu').accordion('refresh');
	     
	     
	 	 if(firstRun == true)
	    	timedFunction = setInterval(function() { getHypervisor(false); },REFRESH_INTERVAL); //we repeat the call
	     
	     });
	 
	 }
</script>

<div id="hypervisors-infopanel">
	<label style="font-weight:bold;" ></label>
	
	<div id="hypervisormenu"></div>
</div>

<div id="vm_menu" class="ui-helper-hidden">
	<button name="startVM" onclick="controlHypervisor()" style="width:'20px';" class="ui-state-disabled">Avvia VM</button>
	<button name="shutVM" onclick="controlHypervisor()" style="width:'20px';" class="ui-state-disabled">Spegni VM</button>
	<button name="stopVM" onclick="controlHypervisor()" style="width:'20px';">Elimina VM</button>
</div>

<div id="vm_creation" class="ui-helper-hidden">
	<div id="vm_creation_loader" hidden="true"
	     style="background: none repeat scroll 0% 0% rgb(255, 255, 255); margin-top: 0px; width: inherit; height: inherit;">
		<img src="images/loading.gif" width="260px">
		<p>Creating...this operation can take some minutes..</p>
	</div>
	<div id="vm_creation_box">
	<label style="font-weight: bold;margin-top:2px;" for="new_vm_name">Nome VM:</label>
	<div id="new_vm_name">
	VPM-<input type="text"></input>
	</div>
	<label style="font-weight: bold;margin-top:2px;" for="new_vm_flavour">Tipo</label>
	<div id="new_vm_flavour">
		<select>
			<option>ubuntu10.04</option>
			<option>dhcpd</option>
		</select>
		
	</div>
	<label style="font-weight: bold;margin-top:10px;" for="new_vm_run">Avvia dopo creazione</label>
	<div id="new_vm_run">
		<input type="checkbox" value="1" checked>
	</div>
	</div>
</div>
